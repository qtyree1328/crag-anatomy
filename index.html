<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CragAnatomy</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Newsreader:ital,wght@0,400;0,500;0,600;1,400&display=swap" rel="stylesheet">
    <!-- Sketchfab Viewer API -->
    <script type="text/javascript" src="https://static.sketchfab.com/api/sketchfab-viewer-1.12.1.js"></script>
    <style>
        :root {
            --bg: #F8F6F3;
            --bg-warm: #FDF9F3;
            --surface: #FFFFFF;
            --text: #2D2A26;
            --text-secondary: #5C5752;
            --text-muted: #8A8580;
            --coral: #E8927C;
            --coral-soft: #FAE8E4;
            --sage: #7BA38F;
            --sage-soft: #E4F0E8;
            --sand: #D4C4A8;
            --sand-soft: #F5F0E6;
            --sky: #8BAEC4;
            --sky-soft: #E4EEF4;
            --gold: #C9A227;
            --gold-soft: #FDF6E3;
            --purple: #9B7BB8;
            --purple-soft: #F0E8F5;
            --shadow-soft: 0 4px 20px rgba(45, 42, 38, 0.06);
            --radius: 24px;
            --radius-sm: 16px;
            --sans: 'Space Grotesk', system-ui, sans-serif;
            --serif: 'Newsreader', Georgia, serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; overflow: hidden; }
        body {
            font-family: var(--sans);
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        .app {
            height: 100%;
            max-width: 480px;
            margin: 0 auto;
            position: relative;
            overflow: hidden;
            background: var(--bg-warm);
        }

        .blob {
            position: fixed;
            border-radius: 50%;
            filter: blur(60px);
            opacity: 0.4;
            pointer-events: none;
            animation: float 20s ease-in-out infinite;
        }
        .blob-1 { width: 300px; height: 300px; background: var(--coral-soft); top: -100px; right: -100px; }
        .blob-2 { width: 250px; height: 250px; background: var(--sage-soft); bottom: 20%; left: -80px; animation-delay: -7s; }
        
        @keyframes float {
            0%, 100% { transform: translate(0, 0); }
            50% { transform: translate(-10px, 10px); }
        }

        .view {
            position: absolute;
            inset: 0;
            display: none;
            flex-direction: column;
            z-index: 1;
        }
        .view.active { display: flex; z-index: 10; }

        .header {
            padding: 16px 20px;
            padding-top: max(16px, env(safe-area-inset-top));
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .logo {
            font-family: var(--serif);
            font-size: 22px;
            font-weight: 600;
        }
        .logo span { color: var(--coral); }

        .session-pill {
            background: var(--surface);
            border-radius: 999px;
            padding: 8px 14px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            box-shadow: var(--shadow-soft);
        }
        .session-pill strong { color: var(--coral); }

        .home-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 0 20px 20px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .hero-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 32px 0;
        }

        .hero-icon {
            width: 120px;
            height: 120px;
            border-radius: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-soft);
            overflow: hidden;
        }
        
        .hero-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .hero-title {
            font-family: var(--serif);
            font-size: 28px;
            font-weight: 500;
            margin-bottom: 10px;
        }

        .hero-subtitle {
            color: var(--text-secondary);
            font-size: 15px;
            max-width: 260px;
        }

        .climb-btn {
            width: 100%;
            padding: 20px;
            background: linear-gradient(135deg, var(--coral) 0%, #D4765F 100%);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-family: var(--sans);
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 8px 24px rgba(232, 146, 124, 0.35);
            margin-bottom: 16px;
            flex-shrink: 0;
        }
        .climb-btn:active { transform: scale(0.98); }

        .next-card {
            background: var(--surface);
            border-radius: var(--radius-sm);
            padding: 16px;
            box-shadow: var(--shadow-soft);
            flex-shrink: 0;
        }

        .next-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            font-weight: 600;
            margin-bottom: 6px;
        }

        .next-muscle {
            font-family: var(--serif);
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .next-region {
            color: var(--text-secondary);
            font-size: 13px;
        }

        .preclimb-header {
            padding: 16px 20px;
            padding-top: max(16px, env(safe-area-inset-top));
            display: flex;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
        }

        .back-btn {
            width: 40px;
            height: 40px;
            background: var(--surface);
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--shadow-soft);
            font-size: 18px;
        }

        .preclimb-title-bar { flex: 1; }
        .preclimb-title-bar h1 {
            font-family: var(--serif);
            font-size: 20px;
            font-weight: 500;
            line-height: 1.2;
        }
        .preclimb-title-bar p {
            font-size: 12px;
            color: var(--text-muted);
            font-style: italic;
        }

        .preclimb-scroll {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 0 20px;
        }

        /* 3D Viewer Container */
        .viewer-3d-container {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: var(--radius);
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
            min-height: 280px;
        }

        .viewer-3d-container iframe {
            width: 100%;
            height: 280px;
            border: none;
            border-radius: var(--radius);
        }

        .viewer-loading {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: white;
            border-radius: var(--radius);
        }

        .viewer-loading.hidden { display: none; }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255,255,255,0.2);
            border-top-color: var(--coral);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 12px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .viewer-badge {
            position: absolute;
            bottom: 12px;
            left: 12px;
            background: rgba(0,0,0,0.6);
            color: white;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .viewer-badge::before {
            content: 'üî¨';
        }

        .anatomy-visual {
            background: linear-gradient(135deg, #f0ede8 0%, #e5e0d8 100%);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
        }

        .anatomy-visual img {
            max-width: 100%;
            max-height: 200px;
            object-fit: contain;
            border-radius: 12px;
        }

        .view-toggle {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .view-toggle-btn {
            flex: 1;
            padding: 12px;
            background: var(--surface);
            border: 2px solid transparent;
            border-radius: var(--radius-sm);
            font-family: var(--sans);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .view-toggle-btn.active {
            border-color: var(--coral);
            color: var(--coral);
            background: var(--coral-soft);
        }

        .cue-card {
            background: linear-gradient(135deg, var(--sage-soft) 0%, #D8EBE0 100%);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 16px;
        }

        .cue-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .cue-icon {
            width: 32px;
            height: 32px;
            background: var(--sage);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .cue-label {
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--sage);
        }

        .cue-text {
            font-size: 15px;
            line-height: 1.5;
            color: var(--text);
        }
        .cue-text strong { color: var(--sage); }

        .info-row {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .info-pill {
            flex: 1;
            background: var(--surface);
            border-radius: var(--radius-sm);
            padding: 14px;
            box-shadow: var(--shadow-soft);
        }

        .pill-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
            font-weight: 600;
            margin-bottom: 4px;
        }

        .pill-value {
            font-size: 13px;
            font-weight: 500;
            color: var(--text);
        }

        .preclimb-footer {
            padding: 16px 20px;
            padding-bottom: max(16px, env(safe-area-inset-bottom));
            display: flex;
            gap: 12px;
            flex-shrink: 0;
        }

        .finish-btn {
            flex: 1;
            padding: 18px;
            background: linear-gradient(135deg, var(--sage) 0%, #5E8A72 100%);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-family: var(--sans);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(123, 163, 143, 0.35);
        }
        .finish-btn:active { transform: scale(0.98); }

        .rest-btn {
            padding: 18px 24px;
            background: var(--surface);
            color: var(--text);
            border: 2px solid var(--sage);
            border-radius: var(--radius);
            font-family: var(--sans);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        .rest-btn:active { background: var(--sage-soft); }

        .rest-header {
            background: linear-gradient(135deg, var(--sage-soft) 0%, #D8EBE0 100%);
            padding: 16px 20px;
            padding-top: max(16px, env(safe-area-inset-top));
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .rest-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .rest-dot {
            width: 10px;
            height: 10px;
            background: var(--sage);
            border-radius: 50%;
            animation: pulse 2s ease infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .rest-label {
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--sage);
        }

        .rest-timer {
            font-size: 22px;
            font-weight: 700;
            color: var(--sage);
        }

        .rest-scroll {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .rest-3d-viewer {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 300px;
            position: relative;
        }

        .rest-3d-viewer iframe {
            width: 100%;
            height: 300px;
            border: none;
        }

        .rest-visual {
            background: linear-gradient(135deg, #f0ede8 0%, #e5e0d8 100%);
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .rest-visual img {
            max-width: 100%;
            max-height: 220px;
            object-fit: contain;
            border-radius: 12px;
            box-shadow: var(--shadow-soft);
        }

        .image-credit {
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 8px;
            text-align: center;
        }

        .rest-details { padding: 20px; }

        .rest-title {
            font-family: var(--serif);
            font-size: 24px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .rest-latin {
            font-family: var(--serif);
            font-style: italic;
            color: var(--text-muted);
            font-size: 13px;
            margin-bottom: 12px;
        }

        .type-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 16px;
        }

        .type-badge.muscle { background: var(--coral-soft); color: var(--coral); }
        .type-badge.nerve { background: var(--gold-soft); color: var(--gold); }
        .type-badge.artery { background: #FDE8E8; color: #C53030; }
        .type-badge.other { background: var(--purple-soft); color: var(--purple); }

        .detail-section { margin-bottom: 16px; }

        .section-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        .section-icon { font-size: 14px; }

        .section-title {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
            font-weight: 700;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .detail-card {
            background: var(--surface);
            border-radius: var(--radius-sm);
            padding: 14px;
            box-shadow: var(--shadow-soft);
        }
        .detail-card.full { grid-column: 1 / -1; }

        .detail-label {
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
            font-weight: 600;
            margin-bottom: 4px;
        }

        .detail-value {
            font-size: 13px;
            color: var(--text);
            line-height: 1.45;
        }

        .nerve-card {
            background: linear-gradient(135deg, var(--gold-soft) 0%, #FCF3D9 100%);
            border-radius: var(--radius-sm);
            padding: 14px;
            box-shadow: var(--shadow-soft);
        }
        .nerve-card .detail-label { color: var(--gold); }

        .artery-card {
            background: linear-gradient(135deg, #FDE8E8 0%, #FCDCDC 100%);
            border-radius: var(--radius-sm);
            padding: 14px;
            box-shadow: var(--shadow-soft);
        }
        .artery-card .detail-label { color: #C53030; }

        .highlight-card {
            background: linear-gradient(135deg, var(--coral-soft) 0%, #FCE4DF 100%);
            border-radius: var(--radius-sm);
            padding: 16px;
        }
        .highlight-card .detail-label { color: var(--coral); }

        .clinical-card {
            background: linear-gradient(135deg, var(--sky-soft) 0%, #D6E8F2 100%);
            border-radius: var(--radius-sm);
            padding: 16px;
        }
        .clinical-card .detail-label { color: var(--sky); }

        .rest-footer {
            padding: 16px 20px;
            padding-bottom: max(16px, env(safe-area-inset-bottom));
            flex-shrink: 0;
        }

        .next-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, var(--coral) 0%, #D4765F 100%);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-family: var(--sans);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(232, 146, 124, 0.35);
        }
        .next-btn:active { transform: scale(0.98); }
    </style>
</head>
<body>
    <div class="app">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>

        <!-- Home -->
        <div class="view active" id="view-home">
            <header class="header">
                <div class="logo">Crag<span>Anatomy</span></div>
                <div class="session-pill">üßó <strong id="climb-count">0</strong></div>
            </header>
            <div class="home-content">
                <div class="hero-section">
                    <div class="hero-icon"><img src="https://media.istockphoto.com/id/485407337/photo/human-anatomy-model.jpg?s=612x612&w=0&k=20&c=xDE9nXiNdsniWdtcqHX9yErSUcfBgTMIjX-kODOFiMw=" alt="Anatomy"></div>
                    <h1 class="hero-title">Ready to Climb?</h1>
                    <p class="hero-subtitle">Learn climbing anatomy with interactive 3D models during rest periods.</p>
                </div>
                <button class="climb-btn" onclick="app.startClimb()">Start Climb ‚Üí</button>
                <div class="next-card">
                    <div class="next-label">Focus</div>
                    <div class="next-muscle" id="next-muscle">Loading...</div>
                    <div class="next-region" id="next-region"></div>
                </div>
            </div>
        </div>

        <!-- Pre-Climb -->
        <div class="view" id="view-preclimb">
            <div class="preclimb-header">
                <button class="back-btn" onclick="app.goHome()">‚Üê</button>
                <div class="preclimb-title-bar">
                    <h1 id="preclimb-title"></h1>
                    <p id="preclimb-latin"></p>
                </div>
            </div>
            <div class="preclimb-scroll">
                <div class="view-toggle">
                    <button class="view-toggle-btn active" id="btn-3d" onclick="app.toggleView('3d')">üî¨ 3D Model</button>
                    <button class="view-toggle-btn" id="btn-2d" onclick="app.toggleView('2d')">üì∑ Image</button>
                </div>
                
                <div class="viewer-3d-container" id="preclimb-3d-container">
                    <div class="viewer-loading" id="preclimb-loading">
                        <div class="loading-spinner"></div>
                        <span>Loading 3D Model...</span>
                    </div>
                    <iframe id="preclimb-3d-frame" src="" allow="autoplay; fullscreen; xr-spatial-tracking" allowfullscreen></iframe>
                    <div class="viewer-badge">Interactive 3D</div>
                </div>
                
                <div class="anatomy-visual" id="preclimb-2d-container" style="display: none;">
                    <img id="preclimb-image" src="" alt="Anatomy">
                </div>
                
                <div class="cue-card">
                    <div class="cue-header">
                        <div class="cue-icon">üí°</div>
                        <span class="cue-label">While You Climb</span>
                    </div>
                    <p class="cue-text" id="preclimb-cue"></p>
                </div>
                <div class="info-row">
                    <div class="info-pill">
                        <div class="pill-label">Action</div>
                        <div class="pill-value" id="preclimb-action"></div>
                    </div>
                    <div class="info-pill">
                        <div class="pill-label">Region</div>
                        <div class="pill-value" id="preclimb-region"></div>
                    </div>
                </div>
            </div>
            <div class="preclimb-footer">
                <button class="rest-btn" onclick="app.skipToRest()">Rest</button>
                <button class="finish-btn" onclick="app.finishClimb()">‚úì Done</button>
            </div>
        </div>

        <!-- Rest -->
        <div class="view" id="view-rest">
            <div class="rest-header">
                <div class="rest-status">
                    <div class="rest-dot"></div>
                    <span class="rest-label">Rest & Learn</span>
                </div>
                <div class="rest-timer" id="rest-timer">0:00</div>
            </div>
            <div class="rest-scroll">
                <div class="rest-3d-viewer" id="rest-3d-container">
                    <div class="viewer-loading" id="rest-loading">
                        <div class="loading-spinner"></div>
                        <span>Loading 3D Model...</span>
                    </div>
                    <iframe id="rest-3d-frame" src="" allow="autoplay; fullscreen; xr-spatial-tracking" allowfullscreen></iframe>
                </div>
                <div class="rest-details">
                    <h2 class="rest-title" id="rest-title"></h2>
                    <p class="rest-latin" id="rest-latin"></p>
                    <span class="type-badge" id="rest-type-badge">Muscle</span>
                    
                    <div class="detail-section">
                        <div class="section-header">
                            <span class="section-icon">üìç</span>
                            <span class="section-title">Attachments</span>
                        </div>
                        <div class="detail-grid">
                            <div class="detail-card">
                                <div class="detail-label">Origin</div>
                                <div class="detail-value" id="rest-origin"></div>
                            </div>
                            <div class="detail-card">
                                <div class="detail-label">Insertion</div>
                                <div class="detail-value" id="rest-insertion"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <div class="section-header">
                            <span class="section-icon">‚ö°</span>
                            <span class="section-title">Neurovascular</span>
                        </div>
                        <div class="detail-grid">
                            <div class="nerve-card">
                                <div class="detail-label">Nerve</div>
                                <div class="detail-value" id="rest-nerve"></div>
                            </div>
                            <div class="artery-card">
                                <div class="detail-label">Artery</div>
                                <div class="detail-value" id="rest-artery"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <div class="section-header">
                            <span class="section-icon">üéØ</span>
                            <span class="section-title">Function</span>
                        </div>
                        <div class="detail-card full">
                            <div class="detail-label">Actions</div>
                            <div class="detail-value" id="rest-actions"></div>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <div class="section-header">
                            <span class="section-icon">üßó</span>
                            <span class="section-title">Climbing</span>
                        </div>
                        <div class="highlight-card">
                            <div class="detail-label">Why Climbers Care</div>
                            <div class="detail-value" id="rest-climbing"></div>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <div class="section-header">
                            <span class="section-icon">üè•</span>
                            <span class="section-title">Clinical Pearl</span>
                        </div>
                        <div class="clinical-card">
                            <div class="detail-label">Medical Note</div>
                            <div class="detail-value" id="rest-clinical"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="rest-footer">
                <button class="next-btn" onclick="app.nextClimb()">üßó Next Climb</button>
            </div>
        </div>
    </div>

    <script>
    // ============================================
    // 3D MODEL REGISTRY - Sketchfab Models
    // ============================================
    const MODELS_3D = {
        // Upper Limb - SGU Medical Art (professional medical models)
        shoulder_arm: {
            uid: '6dd851d018f34892800b83ca418ccb52',
            name: 'Muscles of the Shoulder, Arm, Forearm',
            credit: 'SGU Medical Art',
            // Camera positions for specific structures [eye, target]
            cameras: {
                default: { eye: [0.5, 0.3, 0.6], target: [0, 0, 0] },
                lat: { eye: [-0.4, 0.2, -0.3], target: [0, 0.1, 0] },
                trapezius: { eye: [-0.3, 0.4, -0.4], target: [0, 0.2, 0] },
                deltoid: { eye: [0.4, 0.3, 0.3], target: [0.1, 0.2, 0] },
                biceps: { eye: [0.3, 0, 0.4], target: [0.1, -0.1, 0] },
                triceps: { eye: [-0.3, 0, 0.4], target: [-0.1, -0.1, 0] },
                brachialis: { eye: [0.25, -0.1, 0.35], target: [0.1, -0.15, 0] },
                forearm: { eye: [0.2, -0.3, 0.4], target: [0.1, -0.3, 0] }
            }
        },
        
        // Hand & Forearm
        hand_forearm: {
            uid: '463edeaa8db94bbc975e0dce75dcd795',
            name: 'Anatomy of the Hand and Forearm',
            credit: 'SGU Medical Art',
            cameras: {
                default: { eye: [0.3, 0, 0.4], target: [0, 0, 0] },
                thenar: { eye: [0.15, -0.05, 0.2], target: [0.05, -0.05, 0] },
                hypothenar: { eye: [-0.1, -0.05, 0.2], target: [-0.05, -0.05, 0] },
                lumbricals: { eye: [0.1, -0.1, 0.15], target: [0, -0.1, 0] },
                interossei: { eye: [0, -0.05, -0.2], target: [0, -0.05, 0] },
                fds: { eye: [0.2, 0.1, 0.3], target: [0.1, 0, 0] },
                fdp: { eye: [0.15, 0.05, 0.25], target: [0.05, 0, 0] }
            }
        },
        
        // Brachial Plexus
        brachial_plexus: {
            uid: 'c7c6abed85924baeb04a4d3f4c241083',
            name: 'Brachial Plexus',
            credit: 'lludpt2017',
            cameras: {
                default: { eye: [0, 0, 1], target: [0, 0, 0] },
                roots: { eye: [0, 0.2, 0.8], target: [0, 0.1, 0] },
                cords: { eye: [0, -0.1, 0.8], target: [0, -0.1, 0] }
            }
        },
        
        // Carpal Tunnel - University of Michigan
        carpal_tunnel: {
            uid: 'abe41da6b7c245a09f90fd52cb9c31e0',
            name: 'Carpal Tunnel',
            credit: 'Bluelink Anatomy - University of Michigan',
            cameras: {
                default: { eye: [0, 0, 0.3], target: [0, 0, 0] },
                pulleys: { eye: [0.1, 0, 0.2], target: [0.05, 0, 0] }
            }
        },
        
        // Shoulder Joint
        shoulder_joint: {
            uid: '94489e01f40548b5a0b4f0a6477c36a7',
            name: 'Shoulder Joint',
            credit: 'University of Dundee',
            cameras: {
                default: { eye: [0.5, 0.2, 0.5], target: [0, 0, 0] },
                rotator_cuff: { eye: [-0.3, 0.2, 0.4], target: [0, 0, 0] },
                supraspinatus: { eye: [0, 0.4, 0.3], target: [0, 0.1, 0] },
                subscapularis: { eye: [0.4, 0, 0.3], target: [0, 0, 0] }
            }
        },
        
        // Hand bones with labels
        hand_bones: {
            uid: '1704c8bec5db422fbe17c1e9650c293a',
            name: 'Anatomy of Hand and Wrist Bones',
            credit: 'Soma3D',
            cameras: {
                default: { eye: [0, 0, 0.4], target: [0, 0, 0] }
            }
        }
    };

    // Structure to 3D model mapping
    const STRUCTURE_MODEL_MAP = {
        // Back muscles
        lat: { model: 'shoulder_arm', camera: 'lat' },
        trapezius: { model: 'shoulder_arm', camera: 'trapezius' },
        rhomboids: { model: 'shoulder_arm', camera: 'trapezius' },
        serratus: { model: 'shoulder_arm', camera: 'lat' },
        levator: { model: 'shoulder_arm', camera: 'trapezius' },
        
        // Shoulder
        supraspinatus: { model: 'shoulder_joint', camera: 'supraspinatus' },
        infraspinatus: { model: 'shoulder_joint', camera: 'rotator_cuff' },
        subscapularis: { model: 'shoulder_joint', camera: 'subscapularis' },
        deltoid: { model: 'shoulder_arm', camera: 'deltoid' },
        teres_minor: { model: 'shoulder_joint', camera: 'rotator_cuff' },
        teres_major: { model: 'shoulder_arm', camera: 'lat' },
        
        // Arm
        biceps: { model: 'shoulder_arm', camera: 'biceps' },
        brachialis: { model: 'shoulder_arm', camera: 'brachialis' },
        triceps: { model: 'shoulder_arm', camera: 'triceps' },
        coracobrachialis: { model: 'shoulder_arm', camera: 'biceps' },
        
        // Forearm
        fdp: { model: 'hand_forearm', camera: 'fdp' },
        fds: { model: 'hand_forearm', camera: 'fds' },
        pronator_teres: { model: 'hand_forearm', camera: 'fds' },
        fpl: { model: 'hand_forearm', camera: 'thenar' },
        brachioradialis: { model: 'shoulder_arm', camera: 'forearm' },
        extensors: { model: 'shoulder_arm', camera: 'forearm' },
        
        // Hand
        lumbricals: { model: 'hand_forearm', camera: 'lumbricals' },
        interossei: { model: 'hand_forearm', camera: 'interossei' },
        pulleys: { model: 'carpal_tunnel', camera: 'pulleys' },
        thenar: { model: 'hand_forearm', camera: 'thenar' },
        hypothenar: { model: 'hand_forearm', camera: 'hypothenar' },
        
        // Nerves
        brachial_plexus: { model: 'brachial_plexus', camera: 'default' },
        median_nerve: { model: 'carpal_tunnel', camera: 'default' },
        ulnar_nerve: { model: 'hand_forearm', camera: 'hypothenar' },
        radial_nerve: { model: 'shoulder_arm', camera: 'triceps' },
        musculocutaneous: { model: 'shoulder_arm', camera: 'biceps' },
        axillary_nerve: { model: 'shoulder_joint', camera: 'default' },
        
        // Arteries
        axillary_artery: { model: 'shoulder_arm', camera: 'default' },
        brachial_artery: { model: 'shoulder_arm', camera: 'biceps' },
        radial_ulnar_arteries: { model: 'hand_forearm', camera: 'default' }
    };

    // 2D Image fallbacks
    const IMAGES = {
        forearm: 'https://teachmeanatomy.info/wp-content/uploads/Deep-Flexor-Muscles-of-the-Anterior-Forearm-1024x355.png',
        forearm_superficial: 'https://teachmeanatomy.info/wp-content/uploads/Superficial-Flexor-Muscles-of-the-Anterior-Forearm.png',
        back: 'https://teachmeanatomy.info/wp-content/uploads/Superficial-Muscles-of-the-Back-857x1024.jpg',
        arm: 'https://teachmeanatomy.info/wp-content/uploads/Coracobrachialis-Biceps-and-Brachialis-Muscles.jpg',
        triceps: 'https://teachmeanatomy.info/wp-content/uploads/Long-and-Lateral-Heads-of-the-Triceps-Brachii.jpg',
        shoulder: 'https://teachmeanatomy.info/wp-content/uploads/The-Rotator-Cuff-Muscles-of-the-Shoulder-Joint-1024x357.jpg',
        shoulder_deltoid: 'https://teachmeanatomy.info/wp-content/uploads/The-Deltoid-and-Teres-Major-Muscles-751x1024.jpg',
        hand: 'https://teachmeanatomy.info/wp-content/uploads/Palmar-View-of-the-Thenar-Muscles-of-the-Thumb-and-Hand-Labelled-TeachMeAnatomy.jpg',
        brachial_plexus: 'https://teachmeanatomy.info/wp-content/uploads/2013/02/Labelled-Diagram-of-the-Brachial-Plexus-1024x768.jpg',
        musculocutaneous: 'https://teachmeanatomy.info/wp-content/uploads/2012/04/Musculocutaneous-Nerve-Derivation-from-the-Brachial-Plexus-1024x768.jpg',
        arteries_overview: 'https://teachmeanatomy.info/wp-content/uploads/Overview-of-Arterial-Supply-to-the-Upper-Limbs-1024x944.png',
        axillary_artery: 'https://teachmeanatomy.info/wp-content/uploads/Parts-and-Branches-of-the-Axillary-Artery-1024x520.png',
        brachial_artery: 'https://teachmeanatomy.info/wp-content/uploads/Anatomical-Course-and-Branches-of-the-Brachial-Artery-1024x614.jpg'
    };

    // ============================================
    // ANATOMY DATABASE
    // ============================================
    const ANATOMY_DB = [
        // === MUSCLES: BACK ===
        {
            id: 'lat', name: 'Latissimus Dorsi', latin: 'Musculus latissimus dorsi', type: 'muscle',
            region: 'Back', image: IMAGES.back, credit: 'TeachMeAnatomy',
            origin: 'Spinous processes T7‚ÄìT12, thoracolumbar fascia, iliac crest, inferior 3‚Äì4 ribs',
            insertion: 'Floor of the intertubercular groove of the humerus',
            nerve: 'Thoracodorsal nerve (C6, C7, C8)',
            artery: 'Thoracodorsal artery',
            actions: 'Extension, adduction, and medial rotation of shoulder',
            climbingCue: 'Pay attention to <strong>lat engagement on every pull-down</strong>. Feel the connection from hands to hips.',
            climbingDetail: 'The primary pulling muscle. Every pull-down is powered by lats. Dominant on steep overhangs.',
            clinical: 'Thoracodorsal nerve at risk during axillary lymph node dissection.'
        },
        {
            id: 'trapezius', name: 'Trapezius', latin: 'Musculus trapezius', type: 'muscle',
            region: 'Back', image: IMAGES.back, credit: 'TeachMeAnatomy',
            origin: 'Superior nuchal line, ligamentum nuchae, C7‚ÄìT12 spinous processes',
            insertion: 'Lateral 1/3 clavicle, acromion, spine of scapula',
            nerve: 'Spinal accessory (CN XI)',
            artery: 'Transverse cervical artery',
            actions: 'Upper: elevate. Middle: retract. Lower: depress scapula.',
            climbingCue: 'Pay attention to <strong>trap fibers during different moves</strong>. Lower fibers keep shoulders packed during dead-hangs.',
            climbingDetail: 'Stabilizes scapula throughout every climbing movement.',
            clinical: 'CN XI damage ‚Üí cannot shrug, difficulty abducting past 90¬∞.'
        },
        {
            id: 'rhomboids', name: 'Rhomboid Major & Minor', latin: 'Musculi rhomboidei', type: 'muscle',
            region: 'Back', image: IMAGES.back, credit: 'TeachMeAnatomy',
            origin: 'C7‚ÄìT5 spinous processes',
            insertion: 'Medial border of scapula',
            nerve: 'Dorsal scapular nerve (C5)',
            artery: 'Dorsal scapular artery',
            actions: 'Retract scapula, stabilize scapula to thoracic wall',
            climbingCue: 'Pay attention to <strong>rhomboids when squeezing shoulder blades together</strong>.',
            climbingDetail: 'Fire when you squeeze shoulder blades together during lock-offs.',
            clinical: 'Dorsal scapular nerve entrapment mimics cervical radiculopathy.'
        },
        {
            id: 'serratus', name: 'Serratus Anterior', latin: 'Musculus serratus anterior', type: 'muscle',
            region: 'Thorax', image: IMAGES.back, credit: 'TeachMeAnatomy',
            origin: 'External surfaces of ribs 1‚Äì8',
            insertion: 'Medial border and inferior angle of scapula',
            nerve: 'Long thoracic nerve (C5, C6, C7)',
            artery: 'Lateral thoracic artery',
            actions: 'Protraction of scapula, upward rotation, holds scapula to chest',
            climbingCue: 'Pay attention to <strong>serratus when reaching far or mantling</strong>. The "boxer\'s muscle."',
            climbingDetail: 'Fires every time you reach for a distant hold or push upward.',
            clinical: 'Long thoracic nerve damage ‚Üí classic winged scapula.'
        },
        // === MUSCLES: SHOULDER ===
        {
            id: 'supraspinatus', name: 'Supraspinatus', latin: 'Musculus supraspinatus', type: 'muscle',
            region: 'Shoulder (Rotator Cuff)', image: IMAGES.shoulder, credit: 'TeachMeAnatomy',
            origin: 'Supraspinous fossa of scapula',
            insertion: 'Superior facet of greater tubercle',
            nerve: 'Suprascapular nerve (C5, C6)',
            artery: 'Suprascapular artery',
            actions: 'Initiates abduction (first 0‚Äì15¬∞), stabilizes humeral head',
            climbingCue: 'Pay attention to <strong>supraspinatus when initiating any reach</strong>. Most commonly injured rotator cuff muscle.',
            climbingDetail: 'Works constantly to center humeral head during pulling and reaching.',
            clinical: 'Most commonly torn rotator cuff tendon. Empty can test (Jobe).'
        },
        {
            id: 'infraspinatus', name: 'Infraspinatus', latin: 'Musculus infraspinatus', type: 'muscle',
            region: 'Shoulder (Rotator Cuff)', image: IMAGES.shoulder, credit: 'TeachMeAnatomy',
            origin: 'Infraspinous fossa of scapula',
            insertion: 'Middle facet of greater tubercle',
            nerve: 'Suprascapular nerve (C5, C6)',
            artery: 'Suprascapular artery',
            actions: 'Lateral rotation, posterior stabilization of humeral head',
            climbingCue: 'Pay attention to <strong>infraspinatus during gastons</strong>. Essential for decelerating dynamic moves.',
            climbingDetail: 'Fires during gastons. Works as force couple with subscapularis.',
            clinical: 'Ganglion cyst at spinoglenoid notch ‚Üí isolated lateral rotation weakness.'
        },
        {
            id: 'deltoid', name: 'Deltoid', latin: 'Musculus deltoideus', type: 'muscle',
            region: 'Shoulder', image: IMAGES.shoulder_deltoid, credit: 'TeachMeAnatomy',
            origin: 'Lateral 1/3 clavicle, acromion, scapular spine',
            insertion: 'Deltoid tuberosity on lateral humerus',
            nerve: 'Axillary nerve (C5, C6)',
            artery: 'Posterior circumflex humeral',
            actions: 'Anterior: flexion. Middle: abduction 15‚Äì90¬∞. Posterior: extension.',
            climbingCue: 'Pay attention to <strong>deltoid during top-outs and gastons</strong>. Powers upward push.',
            climbingDetail: 'Primary mover for abduction past 15¬∞.',
            clinical: 'Anterior dislocations ‚Üí axillary nerve injury ‚Üí "regimental badge" anesthesia.'
        },
        // === MUSCLES: ARM ===
        {
            id: 'biceps', name: 'Biceps Brachii', latin: 'Musculus biceps brachii', type: 'muscle',
            region: 'Arm (Anterior)', image: IMAGES.arm, credit: 'TeachMeAnatomy',
            origin: 'Long head: supraglenoid tubercle. Short head: coracoid process.',
            insertion: 'Radial tuberosity + bicipital aponeurosis',
            nerve: 'Musculocutaneous nerve (C5, C6)',
            artery: 'Brachial artery',
            actions: 'Supination (strongest when elbow 90¬∞), elbow flexion',
            climbingCue: 'Pay attention to <strong>biceps on sidepulls and underlings</strong>. Stronger supinator than flexor.',
            climbingDetail: 'Fires with every lock-off. Aponeurosis protects brachial artery + median nerve.',
            clinical: 'Long head rupture ‚Üí "Popeye deformity." Speed\'s test for tendinopathy.'
        },
        {
            id: 'brachialis', name: 'Brachialis', latin: 'Musculus brachialis', type: 'muscle',
            region: 'Arm (Anterior)', image: IMAGES.arm, credit: 'TeachMeAnatomy',
            origin: 'Distal half of anterior humerus',
            insertion: 'Coronoid process of ulna',
            nerve: 'Musculocutaneous (C5, C6); radial nerve (C7)',
            artery: 'Brachial artery',
            actions: 'Elbow flexion ‚Äî primary flexor regardless of forearm position',
            climbingCue: 'Pay attention to <strong>brachialis during lock-offs</strong>. True workhorse of elbow flexion.',
            climbingDetail: 'More important than biceps! Inserts on ulna, so force independent of forearm position.',
            clinical: 'Dual innervation ensures flexion preserved with single nerve injury.'
        },
        {
            id: 'triceps', name: 'Triceps Brachii', latin: 'Musculus triceps brachii', type: 'muscle',
            region: 'Arm (Posterior)', image: IMAGES.triceps, credit: 'TeachMeAnatomy',
            origin: 'Long head: infraglenoid tubercle. Lateral/Medial heads: humerus.',
            insertion: 'Olecranon process of ulna',
            nerve: 'Radial nerve (C6, C7, C8)',
            artery: 'Deep brachial artery',
            actions: 'Elbow extension. Long head: shoulder extension.',
            climbingCue: 'Pay attention to <strong>triceps during mantling and pressing</strong>. Powers top-outs.',
            climbingDetail: 'Long head assists lats in shoulder extension. Essential for push movements.',
            clinical: 'Midshaft humeral fracture ‚Üí wrist drop (radial nerve in spiral groove).'
        },
        // === MUSCLES: FOREARM ===
        {
            id: 'fdp', name: 'Flexor Digitorum Profundus', latin: 'Musculus FDP', type: 'muscle',
            region: 'Forearm (Deep)', image: IMAGES.forearm, credit: 'TeachMeAnatomy',
            origin: 'Proximal 3/4 anterior ulna, interosseous membrane',
            insertion: 'Bases of distal phalanges digits 2‚Äì5',
            nerve: 'Lateral (2,3): anterior interosseous. Medial (4,5): ulnar nerve.',
            artery: 'Anterior interosseous artery',
            actions: 'Flexion of DIP joints ‚Äî ONLY muscle that flexes DIP',
            climbingCue: 'Pay attention to <strong>FDP when crimping</strong>. The final fingertip curl.',
            climbingDetail: 'Only muscle that flexes DIP ‚Äî the crimp engine.',
            clinical: 'Anterior interosseous syndrome: cannot make "OK" sign.'
        },
        {
            id: 'fds', name: 'Flexor Digitorum Superficialis', latin: 'Musculus FDS', type: 'muscle',
            region: 'Forearm (Intermediate)', image: IMAGES.forearm_superficial, credit: 'TeachMeAnatomy',
            origin: 'Medial epicondyle + coronoid. Radial head: anterior radius.',
            insertion: 'Sides of middle phalanges digits 2‚Äì5',
            nerve: 'Median nerve (C7, C8, T1)',
            artery: 'Ulnar artery',
            actions: 'Flexion of PIP joints. Assists MCP and wrist flexion.',
            climbingCue: 'Pay attention to <strong>FDS on slopers and open-hand grips</strong>. Flexes PIP.',
            climbingDetail: 'Crucial for open-hand grips. Splits for FDP (chiasm of Camper).',
            clinical: 'Test: hold all others extended, flex one PIP. FDS to 5th absent in ~20%.'
        },
        // === MUSCLES: HAND ===
        {
            id: 'lumbricals', name: 'Lumbricals', latin: 'Musculi lumbricales', type: 'muscle',
            region: 'Hand (Intrinsic)', image: IMAGES.hand, credit: 'TeachMeAnatomy',
            origin: 'FDP tendons (1st/2nd: unipennate; 3rd/4th: bipennate)',
            insertion: 'Lateral side of extensor expansion',
            nerve: '1st/2nd: median. 3rd/4th: deep ulnar nerve.',
            artery: 'Palmar digital arteries',
            actions: 'Flex MCP + extend PIP and DIP simultaneously',
            climbingCue: 'Pay attention to <strong>lumbricals on slopers and half-crimp</strong>. Enable open-hand grip.',
            climbingDetail: 'Unique: arise from tendons, insert into tendons ‚Äî no bony attachment.',
            clinical: 'Lumbrical shift injury: differential FDP loading pulls lumbrical into carpal tunnel.'
        },
        {
            id: 'interossei', name: 'Dorsal & Palmar Interossei', latin: 'Musculi interossei', type: 'muscle',
            region: 'Hand (Intrinsic)', image: IMAGES.hand, credit: 'TeachMeAnatomy',
            origin: 'Dorsal: adjacent MC sides. Palmar: single MC.',
            insertion: 'Proximal phalanx bases and extensor expansions',
            nerve: 'Deep branch of ulnar nerve (C8, T1)',
            artery: 'Deep palmar arch',
            actions: 'Dorsal: ABduction (DAB). Palmar: ADduction (PAD).',
            climbingCue: 'Pay attention to <strong>interossei for finger spread and squeeze</strong>. DAB for wide holds, PAD for cracks.',
            climbingDetail: 'Fill spaces between metacarpals. Essential for finger control.',
            clinical: 'Low ulnar lesion ‚Üí claw hand. Froment\'s sign for adductor pollicis.'
        },
        {
            id: 'pulleys', name: 'Flexor Pulley System (A2/A4)', latin: 'Vagina fibrosa', type: 'other',
            region: 'Hand (Finger)', image: IMAGES.hand, credit: 'TeachMeAnatomy',
            origin: 'A1: MCP. A2: proximal phalanx. A3: PIP. A4: middle phalanx. A5: DIP.',
            insertion: 'N/A ‚Äî fibrous sheaths constraining flexor tendons',
            nerve: 'N/A (non-contractile connective tissue)',
            artery: 'Digital arteries supply vinculae',
            actions: 'Prevent bowstringing ‚Äî hold tendons close to bone',
            climbingCue: 'Pay attention to <strong>pulley stress when full crimping</strong>. A2 and A4 are critical. Consider half-crimp.',
            climbingDetail: 'THE most clinically relevant structure for climbing injuries. A2 ruptures most often.',
            clinical: 'A2 + A4 most important biomechanically. Flexor tenosynovitis: Kanavel signs = emergency.'
        },
        {
            id: 'thenar', name: 'Thenar Muscles', latin: 'Opponens pollicis, APB, FPB', type: 'muscle',
            region: 'Hand (Thenar)', image: IMAGES.hand, credit: 'TeachMeAnatomy',
            origin: 'Flexor retinaculum, trapezium, scaphoid',
            insertion: 'Opponens: 1st MC. APB: lateral proximal phalanx. FPB: proximal phalanx base.',
            nerve: 'Recurrent branch of median nerve ‚Äî "million dollar nerve"',
            artery: 'Superficial palmar branch of radial',
            actions: 'Opposition, thumb abduction, thumb MCP flexion',
            climbingCue: 'Pay attention to <strong>thenar muscles during every pinch grip</strong>. Feel the thenar eminence contract.',
            climbingDetail: 'Essential for every pinch grip. Recurrent branch emerges just distal to retinaculum.',
            clinical: 'Recurrent branch laceration destroys opposition. "Ape hand" = thenar wasting.'
        },
        {
            id: 'hypothenar', name: 'Hypothenar Muscles', latin: 'Opponens DM, ADM, FDM', type: 'muscle',
            region: 'Hand (Hypothenar)', image: IMAGES.hand, credit: 'TeachMeAnatomy',
            origin: 'Flexor retinaculum, hook of hamate, pisiform',
            insertion: 'Opponens: 5th MC. ADM: medial proximal phalanx. FDM: proximal phalanx base.',
            nerve: 'Deep branch of ulnar nerve (C8, T1)',
            artery: 'Ulnar artery (deep palmar branch)',
            actions: 'Opposition of 5th digit, abduction, 5th MCP flexion',
            climbingCue: 'Pay attention to <strong>hypothenar during crack climbing and side pulls</strong>. Power the pinky side.',
            climbingDetail: 'Form ulnar border of palm. Hook of hamate is key landmark.',
            clinical: 'Ulnar tunnel syndrome (Guyon\'s canal). Cyclists palsy from handlebar pressure.'
        },
        // === NERVES ===
        {
            id: 'brachial_plexus', name: 'Brachial Plexus', latin: 'Plexus brachialis', type: 'nerve',
            region: 'Nerve (Network)', image: IMAGES.brachial_plexus, credit: 'TeachMeAnatomy',
            origin: 'Anterior rami of C5, C6, C7, C8, T1',
            insertion: 'Forms 5 terminal branches: musculocutaneous, axillary, median, radial, ulnar',
            nerve: 'Roots ‚Üí Trunks ‚Üí Divisions ‚Üí Cords ‚Üí Branches',
            artery: 'Travels with subclavian/axillary artery',
            actions: 'Provides ALL motor and most sensory innervation to upper limb',
            climbingCue: 'Pay attention to <strong>brachial plexus during falls</strong>. Shoulder depression + head tilt stretches upper trunk.',
            climbingDetail: 'Source of all upper limb motor control. Upper trunk most vulnerable in climbing falls.',
            clinical: 'Erb-Duchenne (C5-C6): "waiter\'s tip." Klumpke (C8-T1): claw hand + Horner.'
        },
        {
            id: 'median_nerve', name: 'Median Nerve', latin: 'Nervus medianus', type: 'nerve',
            region: 'Nerve (Terminal)', image: IMAGES.brachial_plexus, credit: 'TeachMeAnatomy',
            origin: 'Lateral cord (C5-C7) + Medial cord (C8-T1)',
            insertion: 'All forearm flexors except FCU/medial FDP; thenar muscles; lumbricals 1-2',
            nerve: 'Passes through carpal tunnel. Branch: Anterior interosseous, Recurrent branch.',
            artery: 'Travels with brachial artery in arm',
            actions: 'Pronation, wrist/finger flexion, thumb opposition, lateral 3.5 digit sensation',
            climbingCue: 'Pay attention to <strong>median nerve at carpal tunnel</strong>. Night numbness in thumb/index = carpal tunnel.',
            climbingDetail: 'Key for crimp grip (FDS, FDP 2-3), pinch (thenar), finger dexterity (lumbricals 1-2).',
            clinical: 'Carpal tunnel: nocturnal paresthesias, thenar wasting. "Hand of benediction" making fist.'
        },
        {
            id: 'ulnar_nerve', name: 'Ulnar Nerve', latin: 'Nervus ulnaris', type: 'nerve',
            region: 'Nerve (Terminal)', image: IMAGES.brachial_plexus, credit: 'TeachMeAnatomy',
            origin: 'Medial cord (C8, T1)',
            insertion: 'FCU, medial FDP, hypothenar, interossei, lumbricals 3-4, adductor pollicis',
            nerve: 'Passes posterior to medial epicondyle (cubital tunnel), then Guyon\'s canal',
            artery: 'Travels with ulnar artery',
            actions: 'Wrist flexion/adduction, finger abduction/adduction, thumb adduction',
            climbingCue: 'Pay attention to <strong>ulnar nerve at the elbow</strong>. "Funny bone." Elbow flexion during lock-offs compresses it.',
            climbingDetail: 'Powers finger spread (DAB) and squeeze (PAD). Crucial for crack climbing and pinch grips.',
            clinical: 'Cubital tunnel syndrome: ring/pinky numbness. Claw hand. Froment\'s sign.'
        },
        {
            id: 'radial_nerve', name: 'Radial Nerve', latin: 'Nervus radialis', type: 'nerve',
            region: 'Nerve (Terminal)', image: IMAGES.brachial_plexus, credit: 'TeachMeAnatomy',
            origin: 'Posterior cord (C5-T1)',
            insertion: 'Triceps, brachioradialis, ECRL, then via PIN: all extensors',
            nerve: 'Travels in radial groove with profunda brachii',
            artery: 'Accompanies profunda brachii',
            actions: 'Elbow extension, wrist/finger/thumb extension, supination assist',
            climbingCue: 'Pay attention to <strong>radial nerve during mantles and presses</strong>. Powers extension. Vulnerable at radial groove.',
            climbingDetail: 'Only nerve supplying posterior arm/forearm. Essential for push movements.',
            clinical: 'Wrist drop: can\'t extend wrist/fingers. Saturday night palsy. PIN syndrome: finger drop.'
        },
        // === BLOOD VESSELS ===
        {
            id: 'axillary_artery', name: 'Axillary Artery', latin: 'Arteria axillaris', type: 'artery',
            region: 'Artery (Shoulder)', image: IMAGES.axillary_artery, credit: 'TeachMeAnatomy',
            origin: 'Continuation of subclavian at lateral border of 1st rib',
            insertion: 'Becomes brachial artery at lower border of teres major',
            nerve: 'Surrounded by brachial plexus cords',
            artery: 'Branches: thoracoacromial, subscapular, circumflex humeral',
            actions: 'Primary blood supply to shoulder region',
            climbingCue: 'Pay attention to <strong>axillary artery during shoulder injuries</strong>. Surrounded by brachial plexus cords.',
            climbingDetail: 'Subscapular artery supplies lats, serratus, subscapularis. At risk in dislocations.',
            clinical: 'Axillary artery injury with dislocation is surgical emergency. Pulseless arm = reduce immediately.'
        },
        {
            id: 'brachial_artery', name: 'Brachial Artery', latin: 'Arteria brachialis', type: 'artery',
            region: 'Artery (Arm)', image: IMAGES.brachial_artery, credit: 'TeachMeAnatomy',
            origin: 'Continuation of axillary at teres major',
            insertion: 'Bifurcates into radial and ulnar arteries in cubital fossa',
            nerve: 'Median nerve crosses from lateral to medial',
            artery: 'Branch: Profunda brachii (with radial nerve)',
            actions: 'Primary blood supply to arm and forearm',
            climbingCue: 'Pay attention to <strong>brachial artery for blood pressure checks</strong>. Palpable medial to biceps tendon.',
            climbingDetail: 'Profunda brachii supplies triceps. Protected by bicipital aponeurosis.',
            clinical: 'Supracondylar fracture ‚Üí Volkmann\'s ischemic contracture. 5 P\'s of ischemia.'
        },
        {
            id: 'radial_ulnar_arteries', name: 'Radial & Ulnar Arteries', latin: 'Arteriae radialis et ulnaris', type: 'artery',
            region: 'Artery (Forearm/Hand)', image: IMAGES.arteries_overview, credit: 'TeachMeAnatomy',
            origin: 'Terminal bifurcation of brachial artery',
            insertion: 'Radial: deep palmar arch. Ulnar: superficial palmar arch.',
            nerve: 'Ulnar travels with ulnar nerve',
            artery: 'Palmar arches interconnect for redundant digital supply',
            actions: 'Supply forearm muscles and hand',
            climbingCue: 'Pay attention to <strong>radial artery at the wrist</strong>. Palpate for pulse at snuffbox.',
            climbingDetail: 'Allen\'s test checks both arteries. Ulnar artery usually dominant.',
            clinical: 'Allen\'s test before radial catheterization. Hypothenar hammer syndrome from repetitive trauma.'
        }
    ];

    // ============================================
    // APP LOGIC
    // ============================================
    const app = {
        state: {
            currentIndex: 0,
            climbCount: 0,
            timerInterval: null,
            timerSeconds: 0,
            history: [],
            viewMode: '3d',
            preclimbApi: null,
            restApi: null
        },

        init() {
            this.state.currentIndex = this.getRandomIndex();
            this.updateNextPreview();
        },

        getRandomIndex() {
            const available = [];
            for (let i = 0; i < ANATOMY_DB.length; i++) {
                if (!this.state.history.slice(-5).includes(i)) available.push(i);
            }
            return available.length ? available[Math.floor(Math.random() * available.length)] : Math.floor(Math.random() * ANATOMY_DB.length);
        },

        updateNextPreview() {
            const item = ANATOMY_DB[this.state.currentIndex];
            document.getElementById('next-muscle').textContent = item.name;
            document.getElementById('next-region').textContent = item.region;
        },

        showView(viewId) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
        },

        toggleView(mode) {
            this.state.viewMode = mode;
            document.getElementById('btn-3d').classList.toggle('active', mode === '3d');
            document.getElementById('btn-2d').classList.toggle('active', mode === '2d');
            document.getElementById('preclimb-3d-container').style.display = mode === '3d' ? 'block' : 'none';
            document.getElementById('preclimb-2d-container').style.display = mode === '2d' ? 'flex' : 'none';
        },

        load3DModel(iframeId, loadingId, structureId) {
            const mapping = STRUCTURE_MODEL_MAP[structureId];
            if (!mapping) {
                document.getElementById(loadingId).innerHTML = '<span>3D model not available</span>';
                return;
            }

            const modelData = MODELS_3D[mapping.model];
            if (!modelData) {
                document.getElementById(loadingId).innerHTML = '<span>3D model not available</span>';
                return;
            }

            const iframe = document.getElementById(iframeId);
            const loading = document.getElementById(loadingId);
            loading.classList.remove('hidden');

            const client = new Sketchfab(iframe);
            client.init(modelData.uid, {
                success: (api) => {
                    api.start();
                    api.addEventListener('viewerready', () => {
                        loading.classList.add('hidden');
                        
                        // Set camera to focus on the specific structure
                        const cameraPos = modelData.cameras[mapping.camera] || modelData.cameras.default;
                        if (cameraPos) {
                            api.setCameraLookAt(cameraPos.eye, cameraPos.target, 1.5);
                        }
                    });
                },
                error: () => {
                    loading.innerHTML = '<span>Failed to load 3D model</span>';
                },
                autostart: 1,
                ui_controls: 1,
                ui_infos: 0,
                ui_stop: 0,
                ui_watermark: 0,
                ui_annotations: 0
            });
        },

        startClimb() {
            const item = ANATOMY_DB[this.state.currentIndex];
            document.getElementById('preclimb-image').src = item.image;
            document.getElementById('preclimb-title').textContent = item.name;
            document.getElementById('preclimb-latin').textContent = item.latin;
            document.getElementById('preclimb-action').textContent = item.actions.split('.')[0];
            document.getElementById('preclimb-region').textContent = item.region;
            document.getElementById('preclimb-cue').innerHTML = item.climbingCue;
            
            // Reset view to 3D
            this.toggleView('3d');
            
            // Load 3D model
            this.load3DModel('preclimb-3d-frame', 'preclimb-loading', item.id);
            
            this.showView('view-preclimb');
        },

        finishClimb() {
            this.populateRestView();
            this.startTimer();
            this.state.climbCount++;
            this.state.history.push(this.state.currentIndex);
            document.getElementById('climb-count').textContent = this.state.climbCount;
            this.showView('view-rest');
        },

        skipToRest() {
            this.populateRestView();
            this.startTimer();
            this.showView('view-rest');
        },

        populateRestView() {
            const item = ANATOMY_DB[this.state.currentIndex];
            document.getElementById('rest-title').textContent = item.name;
            document.getElementById('rest-latin').textContent = item.latin;
            
            // Set type badge
            const badge = document.getElementById('rest-type-badge');
            badge.textContent = item.type.charAt(0).toUpperCase() + item.type.slice(1);
            badge.className = 'type-badge ' + item.type;
            
            document.getElementById('rest-origin').textContent = item.origin;
            document.getElementById('rest-insertion').textContent = item.insertion;
            document.getElementById('rest-nerve').textContent = item.nerve;
            document.getElementById('rest-artery').textContent = item.artery;
            document.getElementById('rest-actions').textContent = item.actions;
            document.getElementById('rest-climbing').textContent = item.climbingDetail;
            document.getElementById('rest-clinical').textContent = item.clinical;
            
            // Load 3D model for rest view
            this.load3DModel('rest-3d-frame', 'rest-loading', item.id);
        },

        startTimer() {
            this.state.timerSeconds = 0;
            this.updateTimerDisplay();
            if (this.state.timerInterval) clearInterval(this.state.timerInterval);
            this.state.timerInterval = setInterval(() => {
                this.state.timerSeconds++;
                this.updateTimerDisplay();
            }, 1000);
        },

        updateTimerDisplay() {
            const m = Math.floor(this.state.timerSeconds / 60);
            const s = this.state.timerSeconds % 60;
            document.getElementById('rest-timer').textContent = `${m}:${s.toString().padStart(2, '0')}`;
        },

        stopTimer() {
            if (this.state.timerInterval) {
                clearInterval(this.state.timerInterval);
                this.state.timerInterval = null;
            }
        },

        nextClimb() {
            this.stopTimer();
            this.state.currentIndex = this.getRandomIndex();
            this.updateNextPreview();
            this.startClimb();
        },

        goHome() {
            this.stopTimer();
            this.state.currentIndex = this.getRandomIndex();
            this.updateNextPreview();
            this.showView('view-home');
        }
    };

    document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
